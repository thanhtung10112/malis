{"ast":null,"code":"function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport { takeEvery, put } from 'redux-saga/effects';\nimport { call, select, all } from 'typed-redux-saga';\nimport immer from 'immer';\nimport _ from 'lodash';\nimport { budgetActions, commonStore, advancedFilterActions, summaryReportActions } from '@/store/reducers';\nimport commonApi from '@/apis/common.api';\nimport budgetApi from '@/apis/budget.api';\nexport function* fetchInitDataForList() {\n  const userPuco = yield* select(budgetActions.selectUserPuco);\n  const userJob = yield* select(budgetActions.selectUserJob);\n  const data = yield call(budgetApi.getInitDataForList, {\n    job_id_pk: userJob.value\n  });\n\n  if (_.isNull(data.selected_job)) {\n    ;\n    data.selected_job = {};\n  } // set all_value for all option\n\n\n  data.puco_list = immer(data.puco_list, draft => {\n    const index = _.findIndex(draft, item => _.isNull(item.value));\n\n    draft[index].value = 'all_value';\n  }); // if puco was selected, then set response.user_puco = current selected puco\n\n  if (!_.isNull(userPuco.value)) {\n    data.user_puco = userPuco;\n  }\n\n  yield put(budgetActions.setInitDataForList(data));\n}\nexport function* fetchInitDataForCreateEdit() {\n  const userJob = yield* select(budgetActions.selectUserJob);\n  const data = yield call(budgetApi.getInitDataForCE, {\n    job_id_pk: userJob.value\n  });\n  yield put(budgetActions.setInitDataForCreateEdit(data));\n  yield put(budgetActions.setBudgetDetail({\n    job_id: userJob.value\n  }));\n}\n\nfunction* fetchList() {\n  var _userPuco;\n\n  // eslint-disable-next-line prefer-const\n  let {\n    tableState,\n    searchQuery,\n    filterData,\n    userJob,\n    userPuco\n  } = yield* all({\n    tableState: select(commonStore.selectTableState),\n    searchQuery: select(commonStore.selectSearchQuery),\n    filterData: select(advancedFilterActions.selectFilterData),\n    userJob: select(budgetActions.selectUserJob),\n    userPuco: select(budgetActions.selectUserPuco)\n  });\n\n  if (!userJob.value) {\n    return;\n  }\n\n  if (userPuco.value === 'all_value') {\n    userPuco = immer(userPuco, draft => {\n      draft.value = null;\n    });\n  }\n\n  const {\n    page,\n    per_page\n  } = tableState;\n  const data = yield call(budgetApi.getList, _objectSpread({\n    page,\n    per_page,\n    s: searchQuery,\n    job_id: userJob === null || userJob === void 0 ? void 0 : userJob.value,\n    puco_id: (_userPuco = userPuco) === null || _userPuco === void 0 ? void 0 : _userPuco.value\n  }, filterData));\n  yield put(budgetActions.setDataList(data.budgets));\n  yield put(commonStore.actions.setTableState({\n    total_items: data.total_items\n  }));\n  yield put(budgetActions.setBudgetSum(data.budgets_sum));\n  yield put(budgetActions.setPermissions(data.permissions));\n}\n\nfunction* fetchDetail(id) {\n  const {\n    budget\n  } = yield call(budgetApi.getDetail, id);\n  budget.amount = budget.amount.toString();\n  yield put(budgetActions.setBudgetDetail(budget));\n}\n\nfunction* getList() {\n  yield put(commonStore.actions.setLoadingPage(true));\n\n  try {\n    yield call(fetchInitDataForList);\n    const permissions = yield* select(budgetActions.selectPermissions);\n\n    if (permissions === null || permissions === void 0 ? void 0 : permissions.view) {\n      yield call(fetchList);\n    }\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(commonStore.actions.setLoadingPage(false));\n}\n\nfunction* changeUserValue({\n  payload\n}) {\n  try {\n    const {\n      value,\n      option,\n      confirm\n    } = payload;\n\n    if (confirm === 'save') {\n      yield put(commonStore.sagaUpdateMultiple({\n        entity: 'budget',\n        action: budgetActions.changeUserValue,\n        payloadAction: {\n          value,\n          option\n        }\n      }));\n    } else {\n      yield put(budgetActions.setUserValues({\n        value,\n        option\n      }));\n      yield call(getList);\n    }\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n}\n\nfunction* openCreateDialog() {\n  yield put(commonStore.actions.setLoadingPage(true));\n\n  try {\n    yield call(fetchInitDataForCreateEdit);\n    yield put(budgetActions.setOpenDialog(true));\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(commonStore.actions.setLoadingPage(false));\n}\n\nfunction* create({\n  payload\n}) {\n  yield put(budgetActions.setLoadingDialog(true));\n\n  try {\n    const {\n      message\n    } = yield call(budgetApi.create, payload);\n    yield put(commonStore.actions.setSuccessMessage(message));\n\n    const budgetDetail = _objectSpread(_objectSpread({}, budgetActions.budgetDetail), {}, {\n      job_id: payload.job_id\n    });\n\n    yield put(budgetActions.setBudgetDetail(budgetDetail));\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(budgetActions.setLoadingDialog(false));\n}\n\nfunction* openUpdateDialog({\n  payload\n}) {\n  yield put(commonStore.actions.setLoadingPage(true));\n\n  try {\n    yield all([call(fetchInitDataForCreateEdit), call(fetchDetail, payload)]);\n    yield put(budgetActions.setOpenDialog(true));\n    yield put(budgetActions.setEditMode(true));\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(commonStore.actions.setLoadingPage(false));\n}\n\nfunction* update({\n  payload\n}) {\n  yield put(budgetActions.setLoadingDialog(true));\n\n  try {\n    const {\n      message\n    } = yield call(budgetApi.updateMultiple, [payload]);\n    yield put(commonStore.actions.setSuccessMessage(message));\n    yield call(closeDialog);\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(budgetActions.setLoadingDialog(false));\n}\n\nfunction* remove({\n  payload\n}) {\n  yield put(commonStore.actions.setLoadingPage(true));\n\n  try {\n    const data = yield call(budgetApi.executeOperation, 'delete', payload);\n\n    if (data.failed_count > 0) {\n      yield put(summaryReportActions.setReportData(data));\n      yield put(summaryReportActions.setOpen(true));\n    } else {\n      yield put(commonStore.actions.setSuccessMessage(data.message));\n    }\n\n    yield call(fetchList);\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(commonStore.actions.setLoadingPage(false));\n}\n\nfunction* importCostCode({\n  payload\n}) {\n  yield put(budgetActions.setImportLoading(true));\n\n  try {\n    const data = yield call(commonApi.startBackgroundJob, 'import_budget', payload.operationData, payload.file);\n    yield all([put(budgetActions.setCeleryId(data.celery_id)), put(budgetActions.setOperationId(data.operation_id)), put(budgetActions.setOpenImportProcess(true)), put(budgetActions.setImportMode(payload.mode))]);\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(budgetActions.setImportLoading(false));\n}\n\nfunction* sendReportMail({\n  payload\n}) {\n  yield put(budgetActions.setImportLoading(true));\n\n  try {\n    const {\n      message\n    } = yield call(commonApi.sendReportMail, payload);\n    yield put(commonStore.actions.setSuccessMessage(message));\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(budgetActions.setImportLoading(false));\n}\n\nfunction* getRemindData() {\n  yield put(budgetActions.setImportLoading(true));\n\n  try {\n    const userJob = yield* select(budgetActions.selectUserJob);\n    const remindData = yield* select(budgetActions.selectRemindData);\n\n    if (remindData.helpText) {\n      yield put(budgetActions.setRemindData({\n        open: true\n      }));\n    } else {\n      const {\n        help_text\n      } = yield call(budgetApi.getInitDataForImport, userJob.value);\n      yield put(budgetActions.setRemindData({\n        helpText: help_text,\n        open: true\n      }));\n    }\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(budgetActions.setImportLoading(false));\n}\n\nfunction* closeDialog() {\n  yield put(commonStore.actions.setLoadingPage(true));\n\n  try {\n    yield put(budgetActions.setOpenDialog(false));\n    yield call(fetchList);\n    yield put(budgetActions.setBudgetDetail(_objectSpread({}, budgetActions.budgetDetail)));\n    yield put(budgetActions.setEditMode(false));\n  } catch (error) {\n    yield put(commonStore.actions.setError(error));\n  }\n\n  yield put(commonStore.actions.setLoadingPage(false));\n}\n\nfunction* watchBudgetSaga() {\n  yield takeEvery(budgetActions.openCreateDialog, openCreateDialog);\n  yield takeEvery(budgetActions.closeDialog, closeDialog);\n  yield takeEvery(budgetActions.openUpdateDialog, openUpdateDialog);\n  yield takeEvery(budgetActions.getList, getList);\n  yield takeEvery(budgetActions.changeUserValue, changeUserValue);\n  yield takeEvery(budgetActions.create, create);\n  yield takeEvery(budgetActions.update, update);\n  yield takeEvery(budgetActions.remove, remove);\n  yield takeEvery(budgetActions.importCostCode, importCostCode);\n  yield takeEvery(budgetActions.sendReportMail, sendReportMail);\n  yield takeEvery(budgetActions.getRemindData, getRemindData);\n}\n\nexport default watchBudgetSaga;","map":{"version":3,"sources":["D:/TTS_Reactjs/malis-3-frontend/src/store/saga/budgetSaga.ts"],"names":["takeEvery","put","call","select","all","immer","_","budgetActions","commonStore","advancedFilterActions","summaryReportActions","commonApi","budgetApi","fetchInitDataForList","userPuco","selectUserPuco","userJob","selectUserJob","data","getInitDataForList","job_id_pk","value","isNull","selected_job","puco_list","draft","index","findIndex","item","user_puco","setInitDataForList","fetchInitDataForCreateEdit","getInitDataForCE","setInitDataForCreateEdit","setBudgetDetail","job_id","fetchList","tableState","searchQuery","filterData","selectTableState","selectSearchQuery","selectFilterData","page","per_page","getList","s","puco_id","setDataList","budgets","actions","setTableState","total_items","setBudgetSum","budgets_sum","setPermissions","permissions","fetchDetail","id","budget","getDetail","amount","toString","setLoadingPage","selectPermissions","view","error","setError","changeUserValue","payload","option","confirm","sagaUpdateMultiple","entity","action","payloadAction","setUserValues","openCreateDialog","setOpenDialog","create","setLoadingDialog","message","setSuccessMessage","budgetDetail","openUpdateDialog","setEditMode","update","updateMultiple","closeDialog","remove","executeOperation","failed_count","setReportData","setOpen","importCostCode","setImportLoading","startBackgroundJob","operationData","file","setCeleryId","celery_id","setOperationId","operation_id","setOpenImportProcess","setImportMode","mode","sendReportMail","getRemindData","remindData","selectRemindData","helpText","setRemindData","open","help_text","getInitDataForImport","watchBudgetSaga"],"mappings":"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","sourcesContent":["import { takeEvery, put } from 'redux-saga/effects'\nimport { call, select, all } from 'typed-redux-saga'\nimport immer from 'immer'\nimport _ from 'lodash'\n\nimport { budgetActions, commonStore, advancedFilterActions, summaryReportActions } from '@/store/reducers'\nimport commonApi from '@/apis/common.api'\nimport budgetApi from '@/apis/budget.api'\n\nexport function* fetchInitDataForList() {\n  const userPuco = yield* select(budgetActions.selectUserPuco)\n  const userJob = yield* select(budgetActions.selectUserJob)\n  const data = yield call(budgetApi.getInitDataForList, {\n    job_id_pk: userJob.value\n  })\n  if (_.isNull(data.selected_job)) {\n    ;(data as any).selected_job = {}\n  }\n  // set all_value for all option\n  data.puco_list = immer(data.puco_list, (draft) => {\n    const index = _.findIndex(draft, (item: any) => _.isNull(item.value))\n    draft[index].value = 'all_value'\n  })\n  // if puco was selected, then set response.user_puco = current selected puco\n  if (!_.isNull(userPuco.value)) {\n    data.user_puco = userPuco\n  }\n  yield put(budgetActions.setInitDataForList(data))\n}\n\nexport function* fetchInitDataForCreateEdit() {\n  const userJob = yield* select(budgetActions.selectUserJob)\n  const data = yield call(budgetApi.getInitDataForCE, {\n    job_id_pk: userJob.value\n  })\n  yield put(budgetActions.setInitDataForCreateEdit(data))\n  yield put(budgetActions.setBudgetDetail({ job_id: userJob.value }))\n}\n\nfunction* fetchList() {\n  // eslint-disable-next-line prefer-const\n  let { tableState, searchQuery, filterData, userJob, userPuco } = yield* all({\n    tableState: select(commonStore.selectTableState),\n    searchQuery: select(commonStore.selectSearchQuery),\n    filterData: select(advancedFilterActions.selectFilterData),\n    userJob: select(budgetActions.selectUserJob),\n    userPuco: select(budgetActions.selectUserPuco)\n  })\n  if (!userJob.value) {\n    return\n  }\n  if ((userPuco as any).value === 'all_value') {\n    userPuco = immer(userPuco, (draft) => {\n      draft.value = null\n    })\n  }\n  const { page, per_page } = tableState\n  const data = yield call(budgetApi.getList, {\n    page,\n    per_page,\n    s: searchQuery,\n    job_id: userJob?.value,\n    puco_id: userPuco?.value,\n    ...filterData\n  })\n  yield put(budgetActions.setDataList(data.budgets))\n  yield put(commonStore.actions.setTableState({ total_items: data.total_items }))\n  yield put(budgetActions.setBudgetSum(data.budgets_sum))\n  yield put(budgetActions.setPermissions(data.permissions))\n}\n\nfunction* fetchDetail(id: number) {\n  const { budget } = yield call(budgetApi.getDetail, id)\n  budget.amount = budget.amount.toString() as any\n  yield put(budgetActions.setBudgetDetail(budget))\n}\n\nfunction* getList() {\n  yield put(commonStore.actions.setLoadingPage(true))\n  try {\n    yield call(fetchInitDataForList)\n    const permissions = yield* select(budgetActions.selectPermissions)\n    if (permissions?.view) {\n      yield call(fetchList)\n    }\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n  yield put(commonStore.actions.setLoadingPage(false))\n}\n\nfunction* changeUserValue({ payload }) {\n  try {\n    const { value, option, confirm } = payload\n    if (confirm === 'save') {\n      yield put(\n        commonStore.sagaUpdateMultiple({\n          entity: 'budget',\n          action: budgetActions.changeUserValue,\n          payloadAction: { value, option }\n        })\n      )\n    } else {\n      yield put(budgetActions.setUserValues({ value, option }))\n      yield call(getList)\n    }\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n}\n\nfunction* openCreateDialog() {\n  yield put(commonStore.actions.setLoadingPage(true))\n  try {\n    yield call(fetchInitDataForCreateEdit)\n    yield put(budgetActions.setOpenDialog(true))\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n  yield put(commonStore.actions.setLoadingPage(false))\n}\n\nfunction* create({ payload }: ReturnType<typeof budgetActions.create>) {\n  yield put(budgetActions.setLoadingDialog(true))\n  try {\n    const { message } = yield call(budgetApi.create, payload)\n    yield put(commonStore.actions.setSuccessMessage(message))\n    const budgetDetail = {\n      ...budgetActions.budgetDetail,\n      job_id: payload.job_id\n    }\n    yield put(budgetActions.setBudgetDetail(budgetDetail))\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n  yield put(budgetActions.setLoadingDialog(false))\n}\n\nfunction* openUpdateDialog({ payload }: ReturnType<typeof budgetActions.openUpdateDialog>) {\n  yield put(commonStore.actions.setLoadingPage(true))\n  try {\n    yield all([call(fetchInitDataForCreateEdit), call(fetchDetail, payload)])\n    yield put(budgetActions.setOpenDialog(true))\n    yield put(budgetActions.setEditMode(true))\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n  yield put(commonStore.actions.setLoadingPage(false))\n}\n\nfunction* update({ payload }: ReturnType<typeof budgetActions.update>) {\n  yield put(budgetActions.setLoadingDialog(true))\n  try {\n    const { message } = yield call(budgetApi.updateMultiple, [payload])\n    yield put(commonStore.actions.setSuccessMessage(message))\n    yield call(closeDialog)\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n  yield put(budgetActions.setLoadingDialog(false))\n}\n\nfunction* remove({ payload }: ReturnType<typeof budgetActions.remove>) {\n  yield put(commonStore.actions.setLoadingPage(true))\n\n  try {\n    const data = yield call(budgetApi.executeOperation, 'delete', payload)\n    if (data.failed_count > 0) {\n      yield put(summaryReportActions.setReportData(data))\n      yield put(summaryReportActions.setOpen(true))\n    } else {\n      yield put(commonStore.actions.setSuccessMessage(data.message))\n    }\n    yield call(fetchList)\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n\n  yield put(commonStore.actions.setLoadingPage(false))\n}\n\nfunction* importCostCode({ payload }: ReturnType<typeof budgetActions.importCostCode>) {\n  yield put(budgetActions.setImportLoading(true))\n  try {\n    const data = yield call(commonApi.startBackgroundJob, 'import_budget', payload.operationData, payload.file)\n    yield all([\n      put(budgetActions.setCeleryId(data.celery_id)),\n      put(budgetActions.setOperationId(data.operation_id)),\n      put(budgetActions.setOpenImportProcess(true)),\n      put(budgetActions.setImportMode(payload.mode))\n    ])\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n  yield put(budgetActions.setImportLoading(false))\n}\n\nfunction* sendReportMail({ payload }: ReturnType<typeof budgetActions.sendReportMail>) {\n  yield put(budgetActions.setImportLoading(true))\n  try {\n    const { message } = yield call(commonApi.sendReportMail, payload)\n    yield put(commonStore.actions.setSuccessMessage(message))\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n  yield put(budgetActions.setImportLoading(false))\n}\n\nfunction* getRemindData() {\n  yield put(budgetActions.setImportLoading(true))\n  try {\n    const userJob = yield* select(budgetActions.selectUserJob)\n    const remindData = yield* select(budgetActions.selectRemindData)\n    if (remindData.helpText) {\n      yield put(budgetActions.setRemindData({ open: true }))\n    } else {\n      const { help_text } = yield call(budgetApi.getInitDataForImport, userJob.value)\n      yield put(budgetActions.setRemindData({ helpText: help_text, open: true }))\n    }\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n\n  yield put(budgetActions.setImportLoading(false))\n}\n\nfunction* closeDialog() {\n  yield put(commonStore.actions.setLoadingPage(true))\n  try {\n    yield put(budgetActions.setOpenDialog(false))\n    yield call(fetchList)\n    yield put(budgetActions.setBudgetDetail({ ...budgetActions.budgetDetail }))\n    yield put(budgetActions.setEditMode(false))\n  } catch (error) {\n    yield put(commonStore.actions.setError(error))\n  }\n  yield put(commonStore.actions.setLoadingPage(false))\n}\n\nfunction* watchBudgetSaga() {\n  yield takeEvery(budgetActions.openCreateDialog, openCreateDialog)\n  yield takeEvery(budgetActions.closeDialog, closeDialog)\n  yield takeEvery(budgetActions.openUpdateDialog, openUpdateDialog)\n  yield takeEvery(budgetActions.getList, getList)\n  yield takeEvery(budgetActions.changeUserValue, changeUserValue)\n  yield takeEvery(budgetActions.create, create)\n  yield takeEvery(budgetActions.update, update)\n  yield takeEvery(budgetActions.remove, remove)\n  yield takeEvery(budgetActions.importCostCode, importCostCode)\n  yield takeEvery(budgetActions.sendReportMail, sendReportMail)\n  yield takeEvery(budgetActions.getRemindData, getRemindData)\n}\n\nexport default watchBudgetSaga\n"]},"metadata":{},"sourceType":"module"}